#include <iostream>
#include <locale.h>
#include <cmath>
#include <iomanip>
#include "../headers.h"
#include "../utilidades.h"
#include "entrada_aluno.h"

using namespace std;

/*
 * ??  GAMBIARRA TEMPORÁRIA - Structs Aluno e Emprestimo estão em entrada_aluno.h
 * 
 * PROBLEMA: aluno.cpp original usava essas structs, mas elas não estão em headers.h
 * SOLUÇÃO TEMPORÁRIA: Definir em entrada_aluno.h para compilar
 * 
 * ISSO ESTÁ ERRADO porque:
 * - As structs deveriam estar CENTRALIZADAS em headers.h
 * - entrada_aluno.h deveria APENAS declarar funções, não tipos
 * 
 * TODO - MIGRAÇÃO PARA ESTRUTURAS CORRETAS DE headers.h:
 * 1. Remover struct Aluno de entrada_aluno.h
 * 2. Remover struct Emprestimo de entrada_aluno.h
 * 3. Usar APENAS estruturas de headers.h:
 *    - Identidade, RegistroNotas, Saldo_Cantina, Atraso_Instrumento, Venda_Cantina
 * 4. Reescrever todas as funções para usar headers.h
 * 5. Integrar com leitura/escrita de database/
 * 
 * Ver comentário completo em entrada_aluno.h linhas 6-18

/*
 * ??????????????????????????????????????????????????????????????????????????????
 * ?                    MÓDULO: ENTRADA DO ALUNO                               ?
 * ?                                                                            ?
 * ?  OBJETIVO:                                                                 ?
 * ?  Gerenciar a interface e exibição de dados específicos do aluno, como      ?
 * ?  notas, créditos na lanchonete, empréstimos de instrumentos, etc.         ?
 * ?                                                                            ?
 * ?  PROBLEMA IDENTIFICADO:                                                   ?
 * ?  As estruturas em headers.h (struct Aluno e Emprestimo) armazenam dados    ?
 * ?  APENAS EM MEMÓRIA RAM. Elas NÃO estão ligadas ao banco de dados.         ?
 * ?                                                                            ?
 * ?  ESTRUTURA ATUAL (APENAS MEMÓRIA):                                        ?
 * ?  ???????????????????????                                                   ?
 * ?  ?  struct Aluno       ?  ? Existe em RAM (desaparece ao fechar)          ?
 * ?  ?  - id               ?                                                   ?
 * ?  ?  - nome[50]         ?                                                   ?
 * ?  ?  - notas[4]         ?                                                   ?
 * ?  ?  - credito          ?                                                   ?
 * ?  ?  - compras[20][50]  ?                                                   ?
 * ?  ?  - instrumentos[10] ?                                                   ?
 * ?  ???????????????????????                                                   ?
 * ?                                                                            ?
 * ?  BANCO DE DADOS (PERMANENTE):                                             ?
 * ?  database/                                                                 ?
 * ?  ?? registros_notas.dat      ? notas do aluno                             ?
 * ?  ?? saldos_cantina.dat       ? créditos e vendas                          ?
 * ?  ?? atrasos_instrumentos.dat ? empréstimos                                ?
 * ?  ?? inventario_instrumentos.dat ? instrumentos                            ?
 * ?  ?? turmas.dat               ? inscrições em turmas                       ?
 * ?  ?? eventos.dat              ? eventos disponíveis                        ?
 * ?                                                                            ?
 * ?  FLUXO IDEAL (SER IMPLEMENTADO):                                          ?
 * ?  ??????????????????????????????????????????????????????????????????       ?
 * ?  ? 1. arquivo.dat (banco) ? fread()                               ?       ?
 * ?  ? 2. Popular struct Aluno em memória                             ?       ?
 * ?  ? 3. Usar funções de exibição                                   ?       ?
 * ?  ? 4. Salvar alterações: struct ? fwrite() ? arquivo.dat          ?       ?
 * ?  ??????????????????????????????????????????????????????????????????       ?
 * ?                                                                            ?
 * ?  FUNÇÕES DISPONÍVEIS:                                                     ?
 * ?  ? mostrarNotas()                  - exibe 4 notas + média                 ?
 * ?  ? calcularMedia()                 - calcula média de 4 notas             ?
 * ?  ? mostrarExtratoLanchonete()      - exibe crédito + compras              ?
 * ?  ? mostrarHistoricoEmprestimos()   - exibe empréstimos do aluno           ?
 * ?  ? mostrarInstrumentosAprendidos() - lista instrumentos do aluno          ?
 * ?  ? janela_aluno()                  - menu principal do aluno              ?
 * ?                                                                            ?
 * ?  STATUS: Código funciona sem banco (mostra dados vazios/genéricos)        ?
 * ?  TODO:   Implementar funções de load/save em inicializacao/               ?
 * ?                                                                            ?
 * ??????????????????????????????????????????????????????????????????????????????
 */

// ?????????????????????????????????????????????????????????????????????????????
// FUNÇÃO 1: mostrarNotas()
// ?????????????????????????????????????????????????????????????????????????????
/*
 * DESCRIÇÃO:
 *   Exibe as 4 notas do aluno e calcula a média automaticamente.
 * 
 * PARÂMETROS:
 *   const Aluno &a - referência para struct Aluno com dados em memória
 * 
 * DEPENDÊNCIA DE BANCO:
 *   ?? database/registros_notas.dat
 *   ??  PENDENTE: Função em inicializadores.cpp para carregar notas
 *   
 * FLUXO NECESSÁRIO (ainda não implementado):
 *   1. fopen("database/registros_notas.dat", "rb")
 *   2. fread(&aluno.notas, sizeof(float)*4, 1, arquivo)
 *   3. fclose(arquivo)
 * 
 * STATUS: ? Função exibe corretamente | ? Carregamento de banco pendente
 */
void mostrarNotas(const Aluno &a)
{
    cout << "\n?????????????????????????????????????????????\n";
    cout << "?         NOTAS DO ALUNO                   ?\n";
    cout << "?????????????????????????????????????????????\n";
    cout << fixed << setprecision(2);
    
    float soma = 0;
    for(int i=0; i<4; i++)
    {
        cout << "Nota " << (i+1) << ": " << a.notas[i] << endl;
        soma += a.notas[i];
    }
    cout << "\nMédia: " << (soma/4.0) << endl;
}

// ?????????????????????????????????????????????????????????????????????????????
// FUNÇÃO 2: calcularMedia()
// ?????????????????????????????????????????????????????????????????????????????
/*
 * DESCRIÇÃO:
 *   Calcula a média aritmética de 4 notas do aluno.
 * 
 * PARÂMETROS:
 *   const Aluno &a - referência para struct Aluno
 * 
 * RETORNO:
 *   float - valor da média (0.0 a 10.0)
 * 
 * DEPENDÊNCIA DE BANCO:
 *   ? NENHUMA - Função puramente em memória
 * 
 * STATUS: ? 100% Funcional
 */
float calcularMedia(const Aluno &a)
{
    float soma = 0;
    for(int i=0; i<4; i++)
    {
        soma += a.notas[i];
    }
    return soma / 4.0;
}

// ?????????????????????????????????????????????????????????????????????????????
// FUNÇÃO 3: mostrarExtratoLanchonete()
// ?????????????????????????????????????????????????????????????????????????????
/*
 * DESCRIÇÃO:
 *   Exibe o saldo de crédito do aluno na lanchonete e seu histórico de compras.
 * 
 * PARÂMETROS:
 *   const Aluno &a - referência para struct Aluno com dados em memória
 * 
 * DEPENDÊNCIA DE BANCO:
 *   ?? database/saldos_cantina.dat     - saldos de crédito
 *   ?? database/vendas_cantina.dat     - histórico de compras
 *   ??  PENDENTE: Funções em inicializadores.cpp para carregar vendas
 * 
 * FLUXO NECESSÁRIO (ainda não implementado):
 *   1. fopen("database/saldos_cantina.dat", "rb")
 *   2. Buscar crédito do aluno por ID
 *   3. fopen("database/vendas_cantina.dat", "rb")
 *   4. Buscar compras do aluno por ID
 *   5. fclose() ambos arquivos
 * 
 * STATUS: ? Função exibe corretamente | ? Carregamento de banco pendente
 */
void mostrarExtratoLanchonete(const Aluno &a)
{
    cout << "\n?????????????????????????????????????????????\n";
    cout << "?      EXTRATO DA LANCHONETE                ?\n";
    cout << "?????????????????????????????????????????????\n";
    cout << fixed << setprecision(2);
    cout << "Crédito atual: R$ " << a.credito << "\n\n";

    if(a.quantCompras == 0)
    {
        cout << "Nenhuma compra registrada.\n";
        return;
    }

    cout << "Últimas compras:\n";
    cout << "?????????????????????????????????????????\n";
    for(int i=0; i<a.quantCompras; i++)
    {
        cout << "  " << (i+1) << ". " << a.compras[i] << endl;
    }
    cout << "?????????????????????????????????????????\n";
}

// ?????????????????????????????????????????????????????????????????????????????
// FUNÇÃO 4: mostrarHistoricoEmprestimos()
// ?????????????????????????????????????????????????????????????????????????????
/*
 * DESCRIÇÃO:
 *   Exibe todos os empréstimos de instrumentos associados ao aluno.
 * 
 * PARÂMETROS:
 *   Emprestimo emp[]  - array com registros de empréstimos em memória
 *   int totalEmp      - quantidade de empréstimos no array
 *   int idAluno       - ID do aluno para filtrar empréstimos
 * 
 * DEPENDÊNCIA DE BANCO:
 *   ?? database/atrasos_instrumentos.dat
 *   ??  PENDENTE: Função em inicializadores.cpp para carregar empréstimos
 * 
 * FLUXO NECESSÁRIO (ainda não implementado):
 *   1. fopen("database/atrasos_instrumentos.dat", "rb")
 *   2. Allocar array: Emprestimo emprestimos[100]
 *   3. int total = fread(emprestimos, sizeof(Emprestimo), 100, arquivo)
 *   4. fclose(arquivo)
 *   5. Chamar: mostrarHistoricoEmprestimos(emprestimos, total, idAluno)
 * 
 * STATUS: ? Função busca corretamente | ? Carregamento de banco pendente
 */
void mostrarHistoricoEmprestimos(Emprestimo emp[], int totalEmp, int idAluno)
{
    cout << "\n?????????????????????????????????????????????\n";
    cout << "?    HISTÓRICO DE EMPRÉSTIMOS               ?\n";
    cout << "?????????????????????????????????????????????\n";

    bool encontrou = false;

    for(int i=0; i<totalEmp; i++)
    {
        if(emp[i].idAluno == idAluno)
        {
            encontrou = true;
            cout << "Instrumento ID: " << emp[i].idInstrumento
                 << " | Status: " << (emp[i].devolvido ? "DEVOLVIDO" : "EMPRESTADO") 
                 << endl;
        }
    }

    if(!encontrou)
    {
        cout << "Nenhum empréstimo encontrado para este aluno.\n";
    }
}

// ?????????????????????????????????????????????????????????????????????????????
// FUNÇÃO 5: mostrarInstrumentosAprendidos()
// ?????????????????????????????????????????????????????????????????????????????
/*
 * DESCRIÇÃO:
 *   Exibe a lista de instrumentos que o aluno está aprendendo/aprendeu.
 * 
 * PARÂMETROS:
 *   const Aluno &a - referência para struct Aluno com dados em memória
 * 
 * DEPENDÊNCIA DE BANCO:
 *   ?? database/inventario_instrumentos.dat
 *   ??  PENDENTE: Função em inicializadores.cpp para carregar instrumentos
 * 
 * FLUXO NECESSÁRIO (ainda não implementado):
 *   1. fopen("database/inventario_instrumentos.dat", "rb")
 *   2. Buscar instrumentos onde aluno_id == aluno.id
 *   3. Popular aluno.instrumentos[10]
 *   4. fclose(arquivo)
 * 
 * STATUS: ? Função exibe corretamente | ? Carregamento de banco pendente
 */
void mostrarInstrumentosAprendidos(const Aluno &a) 
{
    cout << "\n?????????????????????????????????????????????\n";
    cout << "?   INSTRUMENTOS APRENDIDOS                 ?\n";
    cout << "?????????????????????????????????????????????\n";

    if (a.quantInstrumentos == 0) 
    {
        cout << "Nenhum instrumento cadastrado.\n";
        return;
    }

    for (int i = 0; i < a.quantInstrumentos; i++) 
    {
        cout << "  " << (i+1) << ". " << a.instrumentos[i] << endl;
    }
}

// ?????????????????????????????????????????????????????????????????????????????
// FUNÇÃO 6: janela_aluno() - MENU PRINCIPAL
// ?????????????????????????????????????????????????????????????????????????????
/*
 * DESCRIÇÃO:
 *   Interface principal do módulo do aluno. Exibe menu com 5 opções de
 *   visualização de dados específicos do aluno.
 * 
 * PARÂMETROS:
 *   login_info info - dados da sessão do aluno (contém ID do aluno)
 * 
 * ESTRUTURA DO MENU:
 *   1. Visualizar Notas
 *      ?? Lê: database/registros_notas.dat
 *      ?? Função: mostrarNotas()
 * 
 *   2. Verificar Frequência
 *      ?? Arquivo: a definir em database/
 *      ?? Função: a criar
 * 
 *   3. Visualizar Turmas
 *      ?? Lê: database/turmas.dat
 *      ?? Função: a criar
 * 
 *   4. Acessar Lanchonete
 *      ?? Lê: database/saldos_cantina.dat, vendas_cantina.dat
 *      ?? Função: mostrarExtratoLanchonete()
 * 
 *   5. Visualizar Eventos
 *      ?? Lê: database/eventos.dat
 *      ?? Função: a criar
 * 
 * TODO - IMPLEMENTAÇÃO NECESSÁRIA EM inicializacao/inicializadores.cpp:
 *   1. Aluno carregar_aluno_por_id(int id)
 *      - Ler de registros_notas.dat
 *      - Ler de saldos_cantina.dat
 *      - Ler de inventario_instrumentos.dat
 *      - Retornar struct Aluno preenchida
 * 
 *   2. void salvar_aluno_em_banco(const Aluno &a)
 *      - Escrever notas em registros_notas.dat
 *      - Escrever crédito em saldos_cantina.dat
 *      - Escrever instrumentos em inventario_instrumentos.dat
 * 
 *   3. Emprestimo* carregar_emprestimos(int &total)
 *      - Ler atrasos_instrumentos.dat
 *      - Retornar array com todos os empréstimos
 * 
 * STATUS:
 *   ? Menu funciona completamente mesmo sem dados do banco
 *   ? Funções de load/save não implementadas
 *   ? Dados das opções 2, 3, 5 não exibem (aguardando funções)
 */
void janela_aluno(login_info info) 
{
    int escolha = -1;
    
    while (escolha != 0) 
    {
        limpar_tela();
        cout << "????????????????????????????????????????????????????????????????\n";
        cout << "  Navegação: Aluno/\n";
        cout << "????????????????????????????????????????????????????????????????\n\n";
        cout << "    ##################################################\n";
        cout << "    #         PAINEL DO ALUNO                      #\n";
        cout << "    ##################################################\n";
        cout << "    #                                              #\n";
        cout << "    #  1 - Visualizar Notas                       #\n";
        cout << "    #      -> Funcao: mostrarNotas()              #\n";
        cout << "    #      -> Banco:  database/registros_notas.dat#\n";
        cout << "    #                                              #\n";
        cout << "    #  2 - Verificar Frequencia                   #\n";
        cout << "    #      -> Funcao: (a criar)                   #\n";
        cout << "    #      -> Banco:  (a definir)                 #\n";
        cout << "    #                                              #\n";
        cout << "    #  3 - Visualizar Turmas                      #\n";
        cout << "    #      -> Funcao: (a criar)                   #\n";
        cout << "    #      -> Banco:  database/turmas.dat         #\n";
        cout << "    #                                              #\n";
        cout << "    #  4 - Acessar Lanchonete                     #\n";
        cout << "    #      -> Funcao: mostrarExtratoLanchonete() #\n";
        cout << "    #      -> Banco:  database/saldos_cantina.dat#\n";
        cout << "    #                                              #\n";
        cout << "    #  5 - Visualizar Eventos                     #\n";
        cout << "    #      -> Funcao: (a criar)                   #\n";
        cout << "    #      -> Banco:  database/eventos.dat        #\n";
        cout << "    #                                              #\n";
        cout << "    #  0 - Sair                                   #\n";
        cout << "    #                                              #\n";
        cout << "    ##################################################\n";
        cout << "\nEscolha uma opcao: ";
        cin >> escolha;
        cin.ignore();
        
        /*
         * PRÓXIMO PASSO - Quando implementar funções de banco:
         * 
         * Aluno aluno = carregar_aluno_por_id(info.id);
         * Emprestimo emprestimos[100];
         * int totalEmprestimos = carregar_emprestimos(&emprestimos);
         * 
         * Depois descomentar as chamadas às funções:
         * case 1: mostrarNotas(aluno); break;
         * case 4: mostrarExtratoLanchonete(aluno); break;
         * case 5: mostrarInstrumentosAprendidos(aluno); break;
         */
        
        switch (escolha) 
        {
            case 1: {
                cout << "\n???????????????????????????????????????????\n";
                cout << "?     NOTAS DO ALUNO                      ?\n";
                cout << "???????????????????????????????????????????\n";
                cout << "?? Função: mostrarNotas() - PRONTA ?\n";
                cout << "?? Banco:  database/registros_notas.dat\n";
                cout << "? Status: Aguardando carregar_aluno_por_id() em\n";
                cout << "          inicializacao/inicializadores.cpp\n";
                cout << "\n(Exibir dados quando carregados em memória)\n";
                system("pause");
                break;
            }
            case 2: {
                cout << "\n? Verificando frequência...\n";
                cout << "?? Status: Função ainda não criada\n";
                cout << "?? Banco:  (arquivo a definir em database/)\n";
                cout << "??  TODO:  Criar função em inicializadores.cpp\n";
                system("pause");
                break;
            }
            case 3: {
                cout << "\n? Visualizando turmas...\n";
                cout << "?? Status: Função ainda não criada\n";
                cout << "?? Banco:  database/turmas.dat\n";
                cout << "??  TODO:  Criar função em inicializadores.cpp\n";
                system("pause");
                break;
            }
            case 4: {
                cout << "\n???????????????????????????????????????????\n";
                cout << "?   EXTRATO DA LANCHONETE                 ?\n";
                cout << "???????????????????????????????????????????\n";
                cout << "?? Função: mostrarExtratoLanchonete() - PRONTA ?\n";
                cout << "?? Banco:  database/saldos_cantina.dat\n";
                cout << "           database/vendas_cantina.dat\n";
                cout << "? Status: Aguardando carregar_aluno_por_id() em\n";
                cout << "          inicializacao/inicializadores.cpp\n";
                cout << "\n(Exibir dados quando carregados em memória)\n";
                system("pause");
                break;
            }
            case 5: {
                cout << "\n? Visualizando eventos...\n";
                cout << "?? Status: Função ainda não criada\n";
                cout << "?? Banco:  database/eventos.dat\n";
                cout << "??  TODO:  Criar função em inicializadores.cpp\n";
                system("pause");
                break;
            }
            case 0: {
                cout << "\n? Saindo do painel do aluno...\n";
                break;
            }
            default: {
                cout << "\n? Opção inválida. Tente novamente.\n";
                system("pause");
            }
        }
    }
}
